<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Selector VOXPOP ‚Äì Cadenas y Calculadora (Final)</title>
  <style>
    :root {
      /* Opci√≥n A - paleta moderna (azul / morado tenue) */
      --primary: #0b467d;
      --primary-hover: #083652;
      --accent: #06B6D4; /* color usado para chips activos y ahora para la franja superior */
      --danger: #EF4444;
      --text: #0F172A;
      --subtext: #475569;
      --background: #F8FAFF;
      --badge-bg: #E6F7FF;
      --badge-text: #0369A1;

      --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      --border: #e5e7eb;
      --muted-bg: #f8fafc;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI','Montserrat',system-ui,Arial, sans-serif;
      background: var(--background);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      background: #fff;
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 1.4rem 1.6rem 2rem;
      position: relative;
    }

    /* Barra superior continua, m√°s ancha, con espacio para logo */
    .top-bar {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: var(--accent); /* mantiene el color que dijiste que est√° perfecto */
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      padding: 12px 20px;
      height: 88px; /* barra amplia para colocar logo */
      box-sizing: border-box;
      color: #fff;
      margin: -1.4rem -1.6rem 1rem -1.6rem; /* expande la barra hasta los bordes del .container visualmente */
      overflow: hidden;
    }
    /* Si prefieres que la barra no sobresalga de los bordes del container, elimina las m√°rgenes negativas anteriores */
    .top-bar .brand {
      display: flex;
      align-items: center;
      gap: .9rem;
    }
    .brand img#brandLogo {
      height: 56px;
      width: auto;
      display: block;
      object-fit: contain;
      filter: brightness(0) saturate(100%) invert(100%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(100%); /* aseguro blanco si el logo es SVG/PNG oscuro; puedes quitarlo si no lo deseas */
    }
    .brand .brand-text {
      font-weight: 900;
      font-size: 1.05rem;
      letter-spacing: .4px;
      color: #fff;
    }
    .top-bar .spacer {
      flex: 1 1 auto;
    }
    /* Opcional: √°rea derecha para acciones (por ejemplo, un bot√≥n peque√±o) */
    .top-bar .actions {
      display:flex;
      gap:.5rem;
      align-items:center;
    }
    .top-bar .actions .small-btn {
      background: transparent;
      color: rgba(255,255,255,0.95);
      border: 1px solid rgba(255,255,255,0.08);
      padding: .4rem .6rem;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }

    h1 { margin: 0 0 .2rem; font-size: 1.9rem; color: var(--primary); }
    .subheader { color: var(--subtext); margin: 0 0 .8rem; }
    .row { display:flex; align-items:center; gap:.6rem; flex-wrap: wrap;}
    .grid { display:grid; gap:.7rem; }
    .g4 { grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); }
    .chip, .button, select, .input { border-radius: 14px; }
    .chip {
      padding: .72rem .9rem; background: #f3f4f6; border: 2px solid var(--border);
      text-align: center; cursor: pointer; font-weight: 700; transition: .18s; user-select: none;
    }
    .chip:hover, .chip:focus { background:#e0e7ff; border-color: var(--primary); }
    .chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .button {
      border: 0; background: var(--primary); color: #fff; font-weight: 800; padding: .88rem 1rem; cursor: pointer;
    }
    .button:hover { background: var(--primary-hover); }
    .button.outline { background: #fff; color: var(--primary); border:2px solid var(--primary); }
    .button.danger { background: var(--danger); }
    .button.danger:hover { background: #b91c1c; }
    .pill {
      padding: .6rem 1rem; border: 2px solid var(--border); border-radius: 999px;
      background: #f3f4f6; cursor: pointer; font-weight: 800; user-select: none; transition: .2s;
      display:inline-block; margin-right:.4rem; margin-top:.2rem;
    }
    .pill.active { background: var(--accent); border-color: var(--accent); color:#fff; }
    select, .input { padding: .7rem 1rem; border: 2px solid var(--border); background: #fff; }
    .input { width: 100%; }
    .badge {
      background: var(--badge-bg); color: var(--badge-text); padding: .45rem .8rem;
      border-radius: 999px; font-weight: 800; display: inline-flex; gap: .4rem; align-items:center;
    }
    .muted { color: #6b7280; }
    .footer-calc {
      margin-top: .8rem; padding: 1rem; border: 2px dashed var(--border);
      border-radius: 14px; background: #fff;
    }
    .total { font-size: 1.2rem; font-weight: 900; margin-top: .3rem; }
    .top-actions { display:flex; gap:.5rem; flex-wrap:wrap; justify-content:flex-end; margin-bottom:.6rem; }
    .hidden { display:none !important; }
    .table-wrap {
      width: 100%;
      overflow-x: auto;
      border: 2px solid var(--border);
      border-radius: 14px;
      background: #fff;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.95rem;
    }
    thead th {
      position: sticky; top: 0; z-index: 1;
      background: var(--muted-bg);
      border-bottom: 2px solid var(--border);
      padding: .6rem .7rem;
      text-align: left;
      font-weight: 800;
    }
    tbody td {
      border-bottom: 1px solid var(--border);
      padding: .6rem .7rem;
      vertical-align: top;
    }
    tbody tr:hover { background: #fafafa; }
    .w-compact { width: 44px; }
    .toggle-btn {
      border: 2px solid var(--border); width: 32px; height: 32px; border-radius: 8px;
      background: #fff; cursor: pointer; font-weight: 900;
      display:flex; align-items:center; justify-content:center;
    }
    .toggle-btn[aria-expanded="true"] { background:#eef2ff; border-color:#c7d2fe; }
    .row-check { width: 18px; height: 18px; }
    .expanded-row td { background: #f9fafb; border-top: 0; }
    .chips { display:flex; gap:.4rem; flex-wrap: wrap; }
    .price { font-weight: 900; white-space: nowrap; }
    .filter-group { display:flex; flex-direction: column; gap:.25rem; min-width: 200px; }
    .filter-label { font-size:.85rem; color:#6b7280; font-weight:700; }

    /* Ajustes responsivos para la barra superior */
    @media (max-width: 900px) {
      .top-bar { height: 72px; padding: 10px 16px; }
      .brand img#brandLogo { height: 48px; }
    }
    @media (max-width: 480px) {
      .top-bar { height: 60px; padding: 8px 12px; }
      .brand img#brandLogo { height: 40px; }
      .brand .brand-text { display: none; } /* oculto texto si el espacio es reducido */
    }
  </style>
  <script>
    window.storeData = window.storeData || [];
  </script>
  <script src="storeData.js"></script>
</head>
<body>
<div class="container">
  <!-- Barra continua amplia en la parte superior para colocar logo -->
  <header class="top-bar" role="banner" aria-label="Barra superior">
    <div class="brand" aria-hidden="false">
      <!-- Reemplaza logo.png por la ruta real de tu logo. Si quieres un SVG en blanco, √∫salo aqu√≠ -->
      <img id="brandLogo" src="Logo Blanco.png" alt="VOXPOP logo" />
      <div class="brand-text">VOXPOP</div>
    </div>

    <div class="spacer" aria-hidden="true"></div>

    <div class="actions" aria-hidden="true">
      <!-- ejemplo de acci√≥n en la barra (opcional) -->
     <a class="small-btn" href="https://voxpop.com.mx/" target="_blank" rel="noopener">Contacto</a>
    </div>
  </header>

  <div class="top-actions" style="margin-top: .4rem;">
    <button id="resetBtn" class="button danger hidden" type="button">üóëÔ∏è Borrar selecci√≥n</button>
  </div>

  <h1>¬øQu√© g√©nero musical tocas?</h1>
  <p class="subheader">Elige uno o m√°s g√©neros. El flujo continuar√° seg√∫n tu perfil.</p>

  <input id="searchGenre" class="input" placeholder="Buscar g√©nero‚Ä¶">
  <div id="genreBadges" class="row" style="margin:.5rem 0;"></div>
  <div id="genreList" class="grid g4" style="margin-bottom:.6rem;"></div>

  <div id="artistTypeSection" class="hidden">
    <h3>¬øEres artista independiente o trabajas con disquera?</h3>
    <div class="row">
      <div id="independentBtn" class="chip" role="button" tabindex="0">Independiente</div>
      <div id="majorBtn" class="chip" role="button" tabindex="0">Major Label</div>
    </div>
  </div>

  <div id="labelsSection" class="hidden" style="margin-top:.6rem;">
    <h3>¬øCon qu√© disquera trabajas?</h3>
    <div id="labelList" class="grid g4"></div>
  </div>

  <div id="associationsSection" class="hidden" style="margin-top:.6rem;">
    <h3>¬øPerteneces a alguna de estas asociaciones?</h3>
    <div id="associationList" class="grid g4"></div>
    <div id="otherAssociationWrap" class="hidden" style="margin-top:.6rem;">
      <input id="otherAssociationName" class="input" placeholder="Escribe el nombre de tu asociaci√≥n...">
    </div>
    <div class="subheader">Si eliges ANDI, el flujo se detiene.</div>
  </div>

  <div id="chainsSection" class="hidden" style="margin-top:.6rem;">
    <h3>¬øEn qu√© cadena te gustar√≠a ser escuchado?</h3>
    <div id="chainList" class="grid g4"></div>
  </div>

  <div id="freqSection" class="hidden" style="margin-top:.6rem;">
    <h3>¬øCu√°ntas veces al d√≠a quieres sonar?</h3>
    <div class="row">
      <div class="pill" data-vpd="3">3 Veces</div>
      <div class="pill" data-vpd="6">6 Veces</div>
      <div class="pill" data-vpd="9">9 Veces</div>
    </div>
  </div>

  <div id="daysSection" class="hidden" style="margin-top:.6rem;">
    <h3>¬øPor cu√°ntos d√≠as quieres ser escuchado?</h3>
    <div class="row">
      <div class="pill" data-days="15">15 D√≠as</div>
      <div class="pill" data-days="30">30 D√≠as</div>
    </div>

    <div id="footerCalc" class="footer-calc hidden">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div>
          <div class="muted" id="countInfo"></div>
          <div class="total" id="grandTotal">Costo total: $0.00 MXN</div>
        </div>
        <div class="row">
          <button id="exportCsvBtn" class="button" type="button">üì§ Enviar solicitud (CSV)</button>
        </div>
      </div>
    </div>
  </div>

  <div id="marketSection" class="hidden" style="margin-top:1rem;">
    <div class="row" style="gap:1rem;">
      <div class="filter-group">
        <span class="filter-label">Filtrar por formato</span>
        <select id="formatSelect"><option value="">Mostrar todos</option></select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Filtrar por estado</span>
        <select id="stateSelect"><option value="">Mostrar todos</option></select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Filtrar por ciudad</span>
        <select id="citySelect"><option value="">Mostrar todos</option></select>
      </div>
    </div>

    <div id="tableMount" class="table-wrap hidden" style="margin-top:.8rem;"></div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const money = n => new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN', minimumFractionDigits:2, maximumFractionDigits:2}).format(Number(n)||0);
const uniq = arr => [...new Set(arr.filter(Boolean))];

function toNumber(x){
  if(typeof x==='number') return x;
  const n = Number(String(x||'').replace(/[^\\d.]/g,''));
  return isFinite(n) ? n : 0;
}

function normalizeName(x){
  if(!x) return '';
  let v = String(x).trim().toUpperCase();
  v = v.replace(/\\s+/g,' ');
  v = v.replace(/^OFFICEMAX$/,'OFFICE MAX');
  v = v.replace(/^UNIVERSO DE FRAGANCIAS$/,'UNIVERSO DE FRAGANCIAS');
  v = v.replace(/^WALMART EXPRESS$/,'WAL-MART EXPRESS');
  v = v.replace(/^WALMART SUPERCENTER$|^WAL\\-MART SUPERCENTER$/,'WAL-MART SUPERCENTER');
  v = v.replace(/^SAMS$|^SAM\\'?S$|^SAM S$/,'SAMS CLUB');
  v = v.replace(/^PERFUMERIA$/,'PERFUMERIA');
  v = v.replace(/^LA COMER$/,'LA COMER');
  return v;
}

const ALL_GENRES = [
  "Ac√∫stico Espa√±ol","Ac√∫stico Ingl√©s","Electro Pop Espa√±ol","Electro Pop Ingl√©s",
  "Indie Espa√±ol","Indie Ingl√©s","Jazz","Lounge","Pop Espa√±ol","Pop Ingl√©s",
  "Pop Latino","Retro Espa√±ol","Retro Ingl√©s","Rock Ingl√©s","Cumbia","Salsa","Banda","Grupero","Norte√±a"
];

const RECORD_LABELS = ["ALTAFONTE","BALBOA RECORDS","BQ & CODA PUBLIS","COMPA√ë√çA FONOGR√ÅFICA",
      "DISCOS CIUDAD","DISCOS MUSART","DISCOS Y CASSETTES PHOENIX","DISCOS Y CINTAS DENVER",
      "EMI MUSIC","MAYRA MUSIC","MEXICAN RECORDS","MULTIMUSIC","MULTITRACK",
      "M√öSICA MEDIA M√âXICO","ORFE√ìN VIDEOVOX","PEERLES-MC","PRODUCCIONES DISCOGR√ÅFICAS MEXICANAS",
      "PRODUCCIONES FONOGR√ÅFICAS JASPER","PROMOTO M√âXICO","SONY MUSIC",
      "UNIVERSAL","WARNER","Otro"];

const ASSOCIATIONS = ["SACM (Como compositor)","ANDI (Como int√©rprete)","AMBAS","OTRO"];

const GENRE_FORMATS_MAJOR = {
  "Ac√∫stico Espa√±ol":[
    {cadena:"LA COMER", formato:"FRESKO"},
    {cadena:"WAL-MART", formato:"SUPERCENTER"},
    {cadena:"SAMS CLUB", formato:"SAMS"},
    {cadena:"PETCO", formato:"PETCO"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ],
  "Ac√∫stico Ingl√©s":[
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"LA COMER", formato:"FRESKO"},
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"WAL-MART", formato:"SUPERCENTER"},
    {cadena:"WAL-MART", formato:"EXPRESS"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ],
  "Electro Pop Espa√±ol":[
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"SORIANA", formato:"SUPER"},
    {cadena:"LA COMER", formato:"LA COMER"},
    {cadena:"LA COMER", formato:"SUMESA"}
  ],
  "Electro Pop Ingl√©s":[
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"SORIANA", formato:"SUPER"},
    {cadena:"LA COMER", formato:"LA COMER"},
    {cadena:"LA COMER", formato:"FRESKO"},
    {cadena:"LA COMER", formato:"SUMESA"},
    {cadena:"WAL-MART", formato:"EXPRESS"},
    {cadena:"SAMS CLUB", formato:"SAMS"},
    {cadena:"UNIVERSO DE FRAGANCIAS", formato:"PERFUMERIA"},
    {cadena:"PETCO", formato:"PETCO"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ],
  "Indie Espa√±ol":[
    {cadena:"SAMS CLUB", formato:"SAMS"}
  ],
  "Indie Ingl√©s":[
    {cadena:"LA COMER", formato:"LA COMER"},
    {cadena:"LA COMER", formato:"SUMESA"},
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"WAL-MART", formato:"SUPERCENTER"},
    {cadena:"WAL-MART", formato:"EXPRESS"},
    {cadena:"SAMS CLUB", formato:"SAMS"},
    {cadena:"PETCO", formato:"PETCO"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ],
  "Jazz":[
    {cadena:"LA COMER", formato:"LA COMER"},
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"WAL-MART", formato:"EXPRESS"}
  ],
  "Lounge":[
    {cadena:"LA COMER", formato:"FRESKO"},
    {cadena:"LA COMER", formato:"SUMESA"},
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"WAL-MART", formato:"EXPRESS"},
    {cadena:"UNIVERSO DE FRAGANCIAS", formato:"PERFUMERIA"}
  ],
  "Pop Espa√±ol":[
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"SORIANA", formato:"SUPER"},
    {cadena:"SORIANA", formato:"MERCADO"},
    {cadena:"LA COMER", formato:"FRESKO"},
    {cadena:"LA COMER", formato:"SUMESA"},
    {cadena:"WAL-MART", formato:"SUPERCENTER"},
    {cadena:"SAMS CLUB", formato:"SAMS"},
    {cadena:"UNIVERSO DE FRAGANCIAS", formato:"PERFUMERIA"},
    {cadena:"PETCO", formato:"PETCO"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ],
  "Pop Ingl√©s":[
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"SORIANA", formato:"SUPER"},
    {cadena:"LA COMER", formato:"FRESKO"},
    {cadena:"LA COMER", formato:"SUMESA"},
    {cadena:"WAL-MART", formato:"SUPERCENTER"},
    {cadena:"WAL-MART", formato:"EXPRESS"},
    {cadena:"SAMS CLUB", formato:"SAMS"},
    {cadena:"UNIVERSO DE FRAGANCIAS", formato:"PERFUMERIA"},
    {cadena:"PETCO", formato:"PETCO"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ],
  "Pop Latino":[
    {cadena:"UNIVERSO DE FRAGANCIAS", formato:"PERFUMERIA"}
  ],
  "Retro Espa√±ol":[
    {cadena:"SAMS CLUB", formato:"SAMS"},
    {cadena:"PETCO", formato:"PETCO"}
  ],
  "Retro Ingl√©s":[
    {cadena:"SAMS CLUB", formato:"SAMS"},
    {cadena:"PETCO", formato:"PETCO"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ],
  "Rock Ingl√©s":[
    {cadena:"LA COMER", formato:"FRESKO"},
    {cadena:"WAL-MART", formato:"SUPERCENTER"},
    {cadena:"WAL-MART", formato:"EXPRESS"},
    {cadena:"UNIVERSO DE FRAGANCIAS", formato:"PERFUMERIA"},
    {cadena:"PETCO", formato:"PETCO"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ]
};

const GENRE_FORMATS_INDEP = {
  "Ac√∫stico Ingl√©s":[
    {cadena:"LIVERPOOL", formato:"LIVERPOOL"},
    {cadena:"SUPER MAYOREO NATURISTA", formato:"SUPER MAYOREO NAT"},
    {cadena:"IKEA", formato:"IKEA"},
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"LA COMER", formato:"FRESKO"},
    {cadena:"WAL-MART", formato:"SUPERCENTER"},
    {cadena:"WAL-MART", formato:"EXPRESS"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ],
  "Ac√∫stico Espa√±ol":[
    {cadena:"SUBURBIA", formato:"SUBURBIA"},
    {cadena:"SUPER MAYOREO NATURISTA", formato:"SUPER MAYOREO NAT"},
    {cadena:"LA COMER", formato:"FRESKO"},
    {cadena:"WAL-MART", formato:"SUPERCENTER"},
    {cadena:"SAMS CLUB", formato:"SAMS"},
    {cadena:"PETCO", formato:"PETCO"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ],
  "Pop Espa√±ol":[
    {cadena:"SORIANA", formato:"SUPER"},
    {cadena:"SORIANA", formato:"MERCADO"},
    {cadena:"UNIVERSO DE FRAGANCIAS", formato:"PERFUMERIA"},
    {cadena:"SUBURBIA", formato:"SUBURBIA"},
    {cadena:"SUPER MAYOREO NATURISTA", formato:"SUPER MAYOREO NAT"},
    {cadena:"IKEA", formato:"IKEA"},
    {cadena:"WOOLWORTH", formato:"WOOLWORTH"},
    {cadena:"ANFORA", formato:"ANFORA"},
    {cadena:"AZULEMEX", formato:"AZULEMEX"},
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"LA COMER", formato:"LA COMER"},
    {cadena:"LA COMER", formato:"FRESKO"},
    {cadena:"LA COMER", formato:"SUMESA"},
    {cadena:"WAL-MART", formato:"SUPERCENTER"},
    {cadena:"SAMS CLUB", formato:"SAMS"},
    {cadena:"PETCO", formato:"PETCO"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ],
  "Pop Ingl√©s":[
    {cadena:"SORIANA", formato:"SUPER"},
    {cadena:"LIVERPOOL", formato:"LIVERPOOL"},
    {cadena:"SUBURBIA", formato:"SUBURBIA"},
    {cadena:"SUPER MAYOREO NATURISTA", formato:"SUPER MAYOREO NAT"},
    {cadena:"FERRIONI", formato:"FERRIONI"},
    {cadena:"IKEA", formato:"IKEA"},
    {cadena:"BED BATH & BEYOND", formato:"BED BATH & BEYOND"},
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"LA COMER", formato:"FRESKO"},
    {cadena:"LA COMER", formato:"SUMESA"},
    {cadena:"WAL-MART", formato:"SUPERCENTER"},
    {cadena:"WAL-MART", formato:"EXPRESS"},
    {cadena:"SAMS CLUB", formato:"SAMS"},
    {cadena:"UNIVERSO DE FRAGANCIAS", formato:"PERFUMERIA"},
    {cadena:"PETCO", formato:"PETCO"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ],
  "Pop Latino":[
    {cadena:"SORIANA", formato:"SUPER"},
    {cadena:"SORIANA", formato:"MERCADO"},
    {cadena:"SUBURBIA", formato:"SUBURBIA"},
    {cadena:"AZULEMEX", formato:"AZULEMEX"}
  ],
  "Electro Pop Ingl√©s":[
    {cadena:"SORIANA", formato:"SUPER"},
    {cadena:"LIVERPOOL", formato:"LIVERPOOL"},
    {cadena:"SUBURBIA", formato:"SUBURBIA"},
    {cadena:"SUPER MAYOREO NATURISTA", formato:"SUPER MAYOREO NAT"},
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"LA COMER", formato:"LA COMER"},
    {cadena:"LA COMER", formato:"FRESKO"},
    {cadena:"LA COMER", formato:"SUMESA"},
    {cadena:"WAL-MART", formato:"EXPRESS"},
    {cadena:"SAMS CLUB", formato:"SAMS"},
    {cadena:"UNIVERSO DE FRAGANCIAS", formato:"PERFUMERIA"},
    {cadena:"PETCO", formato:"PETCO"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ],
  "Electro Pop Espa√±ol":[
    {cadena:"SORIANA", formato:"SUPER"},
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"SORIANA", formato:"MERCADO"},
    {cadena:"LA COMER", formato:"LA COMER"},
    {cadena:"LA COMER", formato:"FRESKO"},
    {cadena:"LA COMER", formato:"SUMESA"},
    {cadena:"WAL-MART", formato:"SUPERCENTER"},
    {cadena:"SAMS CLUB", formato:"SAMS"},
    {cadena:"UNIVERSO DE FRAGANCIAS", formato:"PERFUMERIA"},
    {cadena:"PETCO", formato:"PETCO"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ],
  "Indie Ingl√©s":[
    {cadena:"LIVERPOOL", formato:"LIVERPOOL"},
    {cadena:"LA COMER", formato:"LA COMER"},
    {cadena:"LA COMER", formato:"SUMESA"},
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"WAL-MART", formato:"SUPERCENTER"},
    {cadena:"WAL-MART", formato:"EXPRESS"},
    {cadena:"SAMS CLUB", formato:"SAMS"},
    {cadena:"PETCO", formato:"PETCO"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ],
  "Lounge":[
    {cadena:"SORIANA", formato:"SUPER"},
    {cadena:"LIVERPOOL", formato:"LIVERPOOL"},
    {cadena:"SUPER MAYOREO NATURISTA", formato:"SUPER MAYOREO NAT"},
    {cadena:"LA COMER", formato:"FRESKO"},
    {cadena:"LA COMER", formato:"SUMESA"},
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"WAL-MART", formato:"EXPRESS"},
    {cadena:"UNIVERSO DE FRAGANCIAS", formato:"PERFUMERIA"}
  ],
  "Jazz":[
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"WAL-MART", formato:"EXPRESS"}
  ],
  "Cumbia":[
    {cadena:"SORIANA", formato:"MERCADO"}
  ],
  "Salsa":[
    {cadena:"SORIANA", formato:"MERCADO"},
    {cadena:"SORIANA", formato:"HIPER"},
    {cadena:"WAL-MART", formato:"EXPRESS"}
  ],
  "Banda":[
    {cadena:"SORIANA", formato:"MERCADO"}
  ],
  "Grupero":[
    {cadena:"SUBURBIA", formato:"SUBURBIA"}
  ],
  "Norte√±a":[
    {cadena:"SORIANA", formato:"MERCADO"}
  ],
  "Retro Ingl√©s":[
    {cadena:"AZULEMEX", formato:"AZULEMEX"},
    {cadena:"SAMS CLUB", formato:"SAMS"},
    {cadena:"PETCO", formato:"PETCO"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ],
  "Retro Espa√±ol":[
    {cadena:"ANFORA", formato:"ANFORA"},
    {cadena:"SAMS CLUB", formato:"SAMS"},
    {cadena:"PETCO", formato:"PETCO"}
  ],
  "Rock Ingl√©s":[
    {cadena:"LA COMER", formato:"FRESKO"},
    {cadena:"WAL-MART", formato:"SUPERCENTER"},
    {cadena:"WAL-MART", formato:"EXPRESS"},
    {cadena:"UNIVERSO DE FRAGANCIAS", formato:"PERFUMERIA"},
    {cadena:"PETCO", formato:"PETCO"},
    {cadena:"OFFICE MAX", formato:"OFFICEMAX"}
  ]
};

let selectedGenres = [];
let artistType = null;
let selectedLabel = null;
let selectedAssociation = null;
let selectedChains = new Set();
let VPD = null, DAYS = null;
let selectedStoreIds = new Set();

const searchGenre = $('#searchGenre');
const genreList = $('#genreList');
const genreBadges = $('#genreBadges');
const artistTypeSection = $('#artistTypeSection');
const independentBtn = $('#independentBtn');
const majorBtn = $('#majorBtn');
const labelsSection = $('#labelsSection');
const labelList = $('#labelList');
const associationsSection = $('#associationsSection');
const associationList = $('#associationList');
const chainsSection = $('#chainsSection');
const chainList = $('#chainList');
const freqSection = $('#freqSection');
const daysSection = $('#daysSection');
const marketSection = $('#marketSection');
const formatSelect = $('#formatSelect');
const stateSelect = $('#stateSelect');
const citySelect = $('#citySelect');
const tableMount = $('#tableMount');
const footerCalc = $('#footerCalc');
const countInfo = $('#countInfo');
const grandTotal = $('#grandTotal');
const exportCsvBtn = $('#exportCsvBtn');
const resetBtn = $('#resetBtn');
const otherAssociationWrap = $('#otherAssociationWrap');
const otherAssociationName = $('#otherAssociationName');

function renderGenres(){
  const q = (searchGenre.value||'').toLowerCase();
  genreList.innerHTML='';
  genreBadges.innerHTML='';
  ALL_GENRES.filter(g=>g.toLowerCase().includes(q)).forEach(g=>{
    const el = document.createElement('div');
    el.className = 'chip' + (selectedGenres.includes(g) ? ' active' : '');
    el.textContent = g;
    el.onclick = () => toggleGenre(g);
    genreList.appendChild(el);
  });
  selectedGenres.forEach(g=>{
    const b = document.createElement('span');
    b.className='badge'; b.textContent=g;
    const x = document.createElement('button'); x.textContent='√ó';
    x.style.border='0'; x.style.background='transparent'; x.style.cursor='pointer';
    x.style.color='var(--danger)'; x.onclick=()=>toggleGenre(g);
    b.appendChild(x); genreBadges.appendChild(b);
  });
  artistTypeSection.classList.toggle('hidden', selectedGenres.length===0);
  if(selectedGenres.length===0){ hideAfterGenre(); }
  updateResetVisibility();
}
function toggleGenre(g){
  if(selectedGenres.includes(g)) selectedGenres = selectedGenres.filter(x=>x!==g);
  else selectedGenres.push(g);
  renderGenres(); refreshChainsAndFilters();
}
function hideAfterGenre(){
  artistType = null; selectedLabel = null; selectedAssociation = null;
  independentBtn.classList.remove('active'); majorBtn.classList.remove('active');
  selectedChains.clear(); selectedStoreIds.clear();
  VPD = null; DAYS = null;
  tableMount.classList.add('hidden');
  ['labelsSection','associationsSection','chainsSection','freqSection','daysSection','marketSection'].forEach(id => document.getElementById(id).classList.add('hidden'));
  formatSelect.value=''; stateSelect.value=''; citySelect.value='';
  updateResetVisibility(); updateFooter();
}

independentBtn.onclick = ()=>{
  const was = artistType==='independent';
  artistType = was ? null : 'independent';
  independentBtn.classList.toggle('active', !was);
  majorBtn.classList.remove('active');
  onArtistTypeChange();
};
majorBtn.onclick = ()=>{
  const was = artistType==='major';
  artistType = was ? null : 'major';
  majorBtn.classList.toggle('active', !was);
  independentBtn.classList.remove('active');
  onArtistTypeChange();
};

function onArtistTypeChange(){
  selectedLabel=null; selectedAssociation=null;
  selectedChains.clear(); selectedStoreIds.clear();
  otherAssociationWrap.classList.add('hidden'); otherAssociationName.value='';
  if(artistType==='major'){ labelsSection.classList.remove('hidden'); associationsSection.classList.add('hidden'); renderLabels(); }
  else if(artistType==='independent'){ associationsSection.classList.remove('hidden'); labelsSection.classList.add('hidden'); renderAssociations(); }
  else { labelsSection.classList.add('hidden'); associationsSection.classList.add('hidden'); }
  chainsSection.classList.add('hidden'); freqSection.classList.add('hidden'); daysSection.classList.add('hidden'); marketSection.classList.add('hidden');
  tableMount.classList.add('hidden');
  updateResetVisibility(); updateFooter();
}

function renderLabels(){
  labelList.innerHTML='';
  RECORD_LABELS.forEach(label=>{
    const el = document.createElement('div');
    el.className = 'chip' + (selectedLabel===label ? ' active' : '');
    el.textContent = label;
    el.onclick = ()=>{ 
      if(selectedLabel===label){ selectedLabel=null; }
      else{ selectedLabel=label; }
      renderLabels(); revealChainsIfReady(); updateResetVisibility();
    };
    labelList.appendChild(el);
  });
}

function renderAssociations(){
  associationList.innerHTML='';
  ASSOCIATIONS.forEach(a=>{
    const el = document.createElement('div');
    el.className = 'chip' + (selectedAssociation===a ? ' active' : '');
    el.textContent = a.includes('OTRO') ? 'Otro' : a;
    el.onclick = ()=>{
      if(selectedAssociation===a){ selectedAssociation=null; }
      else { selectedAssociation = a; }
      renderAssociations();
      if(selectedAssociation && selectedAssociation.includes('OTRO')){ otherAssociationWrap.classList.remove('hidden'); } else { otherAssociationWrap.classList.add('hidden'); otherAssociationName.value=''; }
      if(!selectedAssociation){
        chainsSection.classList.add('hidden'); freqSection.classList.add('hidden'); daysSection.classList.add('hidden'); marketSection.classList.add('hidden'); tableMount.classList.add('hidden');
      }else if(selectedAssociation.includes('ANDI')){
        chainsSection.classList.add('hidden'); freqSection.classList.add('hidden'); daysSection.classList.add('hidden'); marketSection.classList.add('hidden'); tableMount.classList.add('hidden');
      }else{
        revealChainsIfReady();
      }
      updateResetVisibility();
    };
    associationList.appendChild(el);
  });
}

function allowedPairs(){
  if(selectedGenres.length===0 || !artistType) return [];
  const map = (artistType==='major' ? GENRE_FORMATS_MAJOR : GENRE_FORMATS_INDEP);
  const pairs = [];
  selectedGenres.forEach(g=>{ (map[g]||[]).forEach(pairs.push.bind(pairs)); });
  return pairs.map(p=>({cadena: normalizeName(p.cadena), formato: normalizeName(p.formato)}));
}
function revealChainsIfReady(){
  const ready = (artistType==='major' && !!selectedLabel) || (artistType==='independent' && !!selectedAssociation && !selectedAssociation.includes('ANDI'));
  chainsSection.classList.toggle('hidden', !ready);
  if(ready){ renderChains(); } else {
    chainsSection.classList.add('hidden'); freqSection.classList.add('hidden'); daysSection.classList.add('hidden'); marketSection.classList.add('hidden'); tableMount.classList.add('hidden');
  }
  updateResetVisibility();
}
function renderChains(){
  const pairs = allowedPairs();
  const allowedChains = uniq(pairs.map(p=>p.cadena));
  const exists = new Set((window.storeData||[]).map(r=>normalizeName(r.CADENA)));
  const finalChains = allowedChains.filter(c=>exists.has(c));
  selectedChains = new Set([...selectedChains].filter(c=>finalChains.includes(c)));
  chainList.innerHTML='';
  finalChains.forEach(c=>{
    const el = document.createElement('div');
    el.className = 'chip' + (selectedChains.has(c) ? ' active' : '');
    el.textContent = c;
    el.onclick = ()=>{ 
      if(selectedChains.has(c)) selectedChains.delete(c); else selectedChains.add(c); 
      renderChains(); buildFiltersAndList();
      const has = selectedChains.size>0;
      freqSection.classList.toggle('hidden', !has);
      if(!has){ daysSection.classList.add('hidden'); marketSection.classList.add('hidden'); tableMount.classList.add('hidden'); }
      updateResetVisibility();
    };
    chainList.appendChild(el);
  });
  if(selectedChains.size>0) buildFiltersAndList();
}

function currentFormatWhitelist(){
  const wl = new Set(allowedPairs().filter(p=>selectedChains.has(p.cadena)).map(p=>p.formato));
  return wl;
}

function getVisibleRows(){
  const wl = currentFormatWhitelist();
  const f = normalizeName(formatSelect.value||'');
  const s = String(stateSelect.value||'');
  const c = String(citySelect.value||'');
  let rows = (window.storeData||[]).map((r,i)=>({
    ...r,_i:i,_id:'s'+i, CADENA: normalizeName(r.CADENA), FORMATO: normalizeName(r.FORMATO)
  }));
  rows = rows.filter(r=> selectedChains.has(normalizeName(r.CADENA)));
  if(wl.size) rows = rows.filter(r=> wl.has(normalizeName(r.FORMATO)));
  if(f) rows = rows.filter(r=> normalizeName(r.FORMATO)===f);
  if(s) rows = rows.filter(r=> String(r.ESTADO||'')===s);
  if(c) rows = rows.filter(r=> String(r.CIUDAD||'')===c);
  return rows;
}

function buildFiltersAndList(){
  const wl = currentFormatWhitelist();
  const rows = (window.storeData||[]).filter(r=> selectedChains.has(normalizeName(r.CADENA)));
  const formats = uniq(rows.map(r=>normalizeName(r.FORMATO))).filter(f=>!wl.size || wl.has(f)).sort();
  const states  = uniq(rows.map(r=>String(r.ESTADO||'').trim())).sort((a,b)=>String(a).localeCompare(String(b),'es'));
  formatSelect.innerHTML = '<option value="">Mostrar todos</option>' + formats.map(f=>`<option>${f}</option>`).join('');
  stateSelect.innerHTML  = '<option value="">Mostrar todos</option>' + states.map(s=>`<option>${s}</option>`).join('');
  refreshCityOptions();
  formatSelect.value = ''; stateSelect.value=''; citySelect.value='';
  renderTable(); updateFooter();
  if(VPD){ daysSection.classList.remove('hidden'); } else { daysSection.classList.add('hidden'); }
  if(VPD && DAYS){ marketSection.classList.remove('hidden'); tableMount.classList.remove('hidden'); renderTable(); } else { marketSection.classList.add('hidden'); tableMount.classList.add('hidden'); }
  updateResetVisibility();
}

function refreshCityOptions(){
  const wl = currentFormatWhitelist();
  const f = normalizeName(formatSelect.value||'');
  const s = String(stateSelect.value||'');
  let rows = (window.storeData||[]).map((r,i)=>({
    ...r,_i:i,_id:'s'+i, CADENA: normalizeName(r.CADENA), FORMATO: normalizeName(r.FORMATO)
  }));
  rows = rows.filter(r=> selectedChains.has(normalizeName(r.CADENA)));
  if(wl.size) rows = rows.filter(r=> wl.has(normalizeName(r.FORMATO)));
  if(f) rows = rows.filter(r=> normalizeName(r.FORMATO)===f);
  if(s) rows = rows.filter(r=> String(r.ESTADO||'')===s);
  const cities  = uniq(rows.map(r=>String(r.CIUDAD||'').trim())).sort((a,b)=>String(a).localeCompare(String(b),'es'));
  citySelect.innerHTML   = '<option value="">Mostrar todos</option>' + cities.map(ci=>`<option>${ci}</option>`).join('');
}

function renderTable(){
  const rows = getVisibleRows();
  const thead = `
    <thead>
      <tr>
        <th class="w-compact"></th>
        <th class="w-compact"><input id="masterCheck" type="checkbox" class="row-check" /></th>
        <th>G√©nero musical</th>
        <th>Cadena</th>
        <th>Formato</th>
        <th>Nombre de la sucursal</th>
        <th>Estado</th>
        <th>Ciudad</th>
        <th>Costo por evento</th>
      </tr>
    </thead>`;
  const tbody = document.createElement('tbody');

  rows.forEach(r=>{
    const id = r._id;
    const pe = (r.POR_EVENTO_NUM!==undefined ? Number(r.POR_EVENTO_NUM) : toNumber(r.POR_EVENTO)) || 0;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="w-compact">
        <button class="toggle-btn" aria-expanded="false" data-id="${id}" title="Mostrar/Ocultar g√©neros">+</button>
      </td>
      <td class="w-compact">
        <input type="checkbox" class="row-check" data-id="${id}" ${selectedStoreIds.has(id)?'checked':''}/>
      </td>
      <td><span class="muted">Ver g√©nero (+)</span></td>
      <td>${normalizeName(r.CADENA)}</td>
      <td>${normalizeName(r.FORMATO)}</td>
      <td>${r.NOMBRE_INTERNO||''}</td>
      <td>${r.ESTADO||''}</td>
      <td>${r.CIUDAD||''}</td>
      <td class="price">${money(pe)}</td>
    `;

    const trExp = document.createElement('tr');
    trExp.className = 'expanded-row hidden';

    const map = (artistType === 'major' ? GENRE_FORMATS_MAJOR : GENRE_FORMATS_INDEP);
    const validGenres = selectedGenres.filter(g => {
      const pairs = map[g] || [];
      return pairs.some(p => 
        normalizeName(p.cadena) === normalizeName(r.CADENA) && 
        normalizeName(p.formato) === normalizeName(r.FORMATO)
      );
    });

    const genresHtml = validGenres.length
      ? `<div class="chips">${validGenres.map(g=>`<span class="badge">${g}</span>`).join(' ')}</div>`
      : `<span class="muted">Ning√∫n g√©nero de los seleccionados aplica para esta sucursal.</span>`;

    trExp.innerHTML = `
      <td></td><td></td>
      <td colspan="7">
        <div class="muted" style="margin-bottom:.4rem;">üéµ G√©nero que puede ser escuchado en esta sucursal:</div>
        ${genresHtml}
      </td>`;

    tr.querySelector('.toggle-btn').onclick = (e)=>{
      const btn = e.currentTarget;
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!expanded));
      btn.textContent = expanded ? '+' : '‚àí';
      trExp.classList.toggle('hidden', expanded);
    };
    tr.querySelector('.row-check').onchange = (e)=>{
      const chk = e.currentTarget;
      if(chk.checked) selectedStoreIds.add(id); else selectedStoreIds.delete(id);
      updateMasterFromRows(); updateFooter(); updateResetVisibility();
    };

    tbody.appendChild(tr);
    tbody.appendChild(trExp);
  });

  const table = document.createElement('table');
  table.innerHTML = thead;
  table.appendChild(tbody);
  tableMount.innerHTML = '';
  tableMount.appendChild(table);

  const master = $('#masterCheck');
  master.onchange = ()=>{
    const visible = getVisibleRows();
    if(master.checked){ visible.forEach(r=> selectedStoreIds.add(r._id)); }
    else { visible.forEach(r=> selectedStoreIds.delete(r._id)); }
    $$('#tableMount .row-check').forEach(chk=>{
      const id = chk.getAttribute('data-id');
      chk.checked = selectedStoreIds.has(id);
    });
    updateMasterFromRows(); updateFooter(); updateResetVisibility();
  };
  updateMasterFromRows();
}

function updateMasterFromRows(){
  const master = $('#masterCheck');
  if(!master) return;
  const visible = getVisibleRows();
  const total = visible.length;
  const checked = visible.filter(r=> selectedStoreIds.has(r._id)).length;
  master.indeterminate = false;
  if(total===0){ master.checked=false; return; }
  if(checked===0){ master.checked=false; }
  else if(checked===total){ master.checked=true; }
  else { master.checked=false; master.indeterminate = true; }
}

function updateFooter(){
  const visible = getVisibleRows();
  const selectedVisible = visible.filter(r=> selectedStoreIds.has(r._id));
  footerCalc.classList.toggle('hidden', selectedVisible.length===0 || !VPD || !DAYS);
  if(selectedVisible.length===0 || !VPD || !DAYS){
    grandTotal.textContent='Costo total: $0.00 MXN'; countInfo.textContent=''; return;
  }
  const sumEvent = selectedVisible.reduce((acc,r)=>{
    const peNum = (r.POR_EVENTO_NUM!==undefined ? Number(r.POR_EVENTO_NUM) : toNumber(r.POR_EVENTO));
    return acc + (peNum||0);
  },0);
  const total = sumEvent * VPD * DAYS;
  countInfo.textContent = `${selectedVisible.length} tienda(s) seleccionada(s) visibles ‚Ä¢ ${VPD} veces/d√≠a ‚Ä¢ ${DAYS} d√≠a(s)`;
  grandTotal.textContent = `Costo total: ${money(total)} MXN`;
}

function anySelectionMade(){
  return (
    selectedGenres.length>0 ||
    !!artistType ||
    !!selectedLabel ||
    (!!selectedAssociation && !selectedAssociation.includes('ANDI')) ||
    selectedChains.size>0 ||
    formatSelect.value!=='' ||
    stateSelect.value!=='' ||
    citySelect.value!=='' ||
    selectedStoreIds.size>0 ||
    (otherAssociationName && otherAssociationName.value && otherAssociationName.value.trim()!=='') ||
    !!VPD || !!DAYS
  );
}
function updateResetVisibility(){
  resetBtn.classList.toggle('hidden', !anySelectionMade());
}

formatSelect.onchange = ()=>{ refreshCityOptions(); renderTable(); updateFooter(); updateResetVisibility(); };
stateSelect.onchange  = ()=>{ refreshCityOptions(); renderTable(); updateFooter(); updateResetVisibility(); };
citySelect.onchange   = ()=>{ renderTable(); updateFooter(); updateResetVisibility(); };

function pickPill(containerSelector, attr, val){
  $$(containerSelector+' .pill['+attr+']').forEach(p=> p.classList.toggle('active', String(p.getAttribute(attr))===String(val)));
}
document.addEventListener('click', (e)=>{
  const vpd = e.target.getAttribute('data-vpd');
  const days = e.target.getAttribute('data-days');
  if(vpd){
    const n = Number(vpd);
    if(VPD===n){
      VPD = null;
      pickPill('body','data-vpd','__none__');
      daysSection.classList.add('hidden');
      marketSection.classList.add('hidden');
      tableMount.classList.add('hidden');
    }else{
      VPD = n;
      pickPill('body','data-vpd',VPD);
      daysSection.classList.remove('hidden');
      if(DAYS){ marketSection.classList.remove('hidden'); tableMount.classList.remove('hidden'); renderTable(); }
    }
    updateFooter(); updateResetVisibility();
  }
  if(days){
    const n = Number(days);
    if(DAYS===n){
      DAYS = null;
      pickPill('body','data-days','__none__');
      marketSection.classList.add('hidden');
      tableMount.classList.add('hidden');
    }else{
      DAYS = n;
      pickPill('body','data-days',DAYS);
      if(VPD){ marketSection.classList.remove('hidden'); tableMount.classList.remove('hidden'); renderTable(); }
    }
    updateFooter(); updateResetVisibility();
  }
});

/*
  Funci√≥n exportSelectedCSV:
  - Orden de columnas solicitado:
    GENERO_APLICA, GENEROS_SELECCIONADOS, DISQUERA_ASOCIACION,
    CADENA, FORMATO, NOMBRE_INTERNO, ESTADO, CIUDAD,
    POR_EVENTO, VPD, DAYS, TOTAL_POR_TIENDA
  - Incluye BOM para Excel y timestamp en el nombre del archivo.
  - Escapa comillas dobles.
*/
function exportSelectedCSV(){
  const visible = getVisibleRows();
  const rows = visible.filter(r=> selectedStoreIds.has(r._id));
  if(rows.length===0){ alert('No hay tiendas seleccionadas (visibles).'); return; }

  const headers = [
    'GENERO_APLICA',
    'GENROS_SELECCIONADOS',
    'DISQUERA_ASOCIACION',
    'CADENA',
    'FORMATO',
    'NOMBRE_INTERNO',
    'ESTADO',
    'CIUDAD',
    'POR_EVENTO',
    'VPD',
    'DAYS',
    'TOTAL_POR_TIENDA'
  ];

  const pad = n=>String(n).padStart(2,'0');
  const now = new Date();
  const stamp = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;

  const labelOrAssociation = (() => {
    if(artistType === 'major' && selectedLabel) return selectedLabel;
    if(artistType === 'independent' && selectedAssociation) {
      if(selectedAssociation.includes('OTRO')) return (otherAssociationName && otherAssociationName.value.trim()) ? otherAssociationName.value.trim() : 'OTRO';
      return selectedAssociation;
    }
    return '';
  })();

  const allSelectedGenresStr = selectedGenres.length ? selectedGenres.join('; ') : '';

  const csvRows = rows.map(r=>{
    const map = (artistType === 'major' ? GENRE_FORMATS_MAJOR : GENRE_FORMATS_INDEP);
    const validGenres = selectedGenres.filter(g => {
      const pairs = map[g] || [];
      return pairs.some(p =>
        normalizeName(p.cadena) === normalizeName(r.CADENA) &&
        normalizeName(p.formato) === normalizeName(r.FORMATO)
      );
    });
    const generoAplica = validGenres.length ? validGenres.join('; ') : '';

    const peNum = (r.POR_EVENTO_NUM!==undefined) ? Number(r.POR_EVENTO_NUM) : toNumber(r.POR_EVENTO);
    const v = VPD || '';
    const d = DAYS || '';
    const totalPorTienda = (peNum && VPD && DAYS) ? (peNum * VPD * DAYS) : '';

    const values = [
      generoAplica,
      allSelectedGenresStr,
      labelOrAssociation,
      r.CADENA||'',
      r.FORMATO||'',
      r.NOMBRE_INTERNO||'',
      r.ESTADO||'',
      r.CIUDAD||'',
      peNum!==undefined && peNum!==null ? peNum : '',
      v,
      d,
      totalPorTienda
    ];
    return values.map(val=>`"${String(val).replace(/"/g,'""')}"`).join(',');
  });

  const grandTotalNum = rows.reduce((acc,r)=>{
    const peNum = (r.POR_EVENTO_NUM!==undefined) ? Number(r.POR_EVENTO_NUM) : toNumber(r.POR_EVENTO);
    return acc + ((peNum||0) * (VPD||0) * (DAYS||0));
  },0);

  const summaryRow = [
    '__TOTAL__',
    '',
    labelOrAssociation || '',
    '',
    '',
    '',
    '',
    '',
    '',
    VPD||'',
    DAYS||'',
    grandTotalNum ? grandTotalNum : ''
  ].map(val=>`"${String(val).replace(/"/g,'""')}"`).join(',');

  const csvContent = [headers.join(',')].concat(csvRows).concat([summaryRow]).join('\n');

  const bom = '\uFEFF';
  const blob = new Blob([bom + csvContent], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `solicitud_tiendas_seleccionadas_${stamp}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(a.href);
}
exportCsvBtn.onclick = exportSelectedCSV;

function resetAll(){
  selectedGenres = [];
  artistType = null;
  selectedLabel = null;
  selectedAssociation = null;
  selectedChains.clear();
  selectedStoreIds.clear();
  VPD = null; DAYS = null;
  searchGenre.value = '';
  formatSelect.value=''; stateSelect.value=''; citySelect.value='';
  if(otherAssociationName) otherAssociationName.value='';
  ['labelsSection','associationsSection','chainsSection','freqSection','daysSection','marketSection']
    .forEach(id => document.getElementById(id).classList.add('hidden'));
  genreBadges.innerHTML='';
  independentBtn.classList.remove('active'); majorBtn.classList.remove('active');
  chainList.innerHTML='';
  tableMount.classList.add('hidden');
  renderGenres();
  updateFooter();
  updateResetVisibility();
}
resetBtn.onclick = resetAll;

function refreshChainsAndFilters(){
  if(!artistType){
    chainsSection.classList.add('hidden'); freqSection.classList.add('hidden'); daysSection.classList.add('hidden'); marketSection.classList.add('hidden');
    tableMount.classList.add('hidden');
    return;
  }
  revealChainsIfReady();
}
searchGenre.addEventListener('input', ()=>{ renderGenres(); updateResetVisibility(); });

(function normalizeStore(){
  window.storeData = (window.storeData||[])
    .filter(r=>r && r.CADENA && r.FORMATO && r.NOMBRE_INTERNO)
    .map(r=>{
      const num = (r.POR_EVENTO_NUM!==undefined) ? Number(r.POR_EVENTO_NUM) : toNumber(r.POR_EVENTO);
      return {
        ...r,
        POR_EVENTO_NUM: num,
        CADENA: normalizeName(r.CADENA),
        FORMATO: normalizeName(r.FORMATO)
      };
    });
})();

renderGenres();
updateResetVisibility();
</script>
</body>
</html>
